<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Squedy - Gest√£o de Lembretes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

    <style>
			/* Estilo para √çcones de Informa√ß√£o e Tooltips */
		.info-tip {
			color: var(--primary);
			font-size: 0.85rem;
			cursor: help;
			margin-left: 6px;
			transition: 0.3s;
		}

		.info-tip:hover { color: var(--dark-blue); }

		[data-tip] { position: relative; }
		[data-tip]:hover::after {
			content: attr(data-tip);
			position: absolute;
			bottom: 125%;
			left: 50%;
			transform: translateX(-50%);
			background: #333;
			color: #fff;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 0.75rem;
			white-space: normal;
			width: 200px;
			z-index: 1000;
			box-shadow: 0 4px 10px rgba(0,0,0,0.2);
			font-weight: normal;
			line-height: 1.4;
		}
	
			/* Tooltip de Informa√ß√£o */
		.info-tip {
			color: var(--primary);
			font-size: 0.85rem;
			cursor: help;
			margin-left: 6px;
			transition: 0.3s;
		}

		.info-tip:hover { color: var(--dark-blue); }

		[data-tip] { position: relative; }
		[data-tip]:hover::after {
			content: attr(data-tip);
			position: absolute;
			bottom: 125%;
			left: 50%;
			transform: translateX(-50%);
			background: #333;
			color: #fff;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 0.75rem;
			white-space: normal;
			width: 180px;
			z-index: 1000;
			box-shadow: 0 4px 10px rgba(0,0,0,0.2);
			font-weight: 400;
		}
        :root {
            --sidebar-width: 260px;
            --primary: #2563eb;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --text: #1e293b;
            --dark-blue: #0f172a;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; background: var(--bg); color: var(--text); }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: var(--dark-blue); height: 100vh; color: white; position: fixed; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 30px; font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-links { flex: 1; padding: 20px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #94a3b8; text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; }
        .nav-item.active { border-left: 4px solid var(--secondary); }

        /* MAIN CONTENT */
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 40px; box-sizing: border-box; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
		
		/* FILTROS */
        .filter-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-container input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; flex: 1; font-family: inherit; }

        
        /* CARDS DE RESUMO */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary); }
        .stat-card h3 { margin: 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; }
        .stat-card .value { font-size: 2rem; font-weight: 800; margin: 10px 0; }

        /* TABELAS */
        .data-table-container { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 20px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #f1f5f9; color: #64748b; font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .badge-status { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-hoje { background: #fef3c7; color: #92400e; }
		.btn-ignore { background: #94a3b8; color: white; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; border: none; cursor: pointer; }
		.btn-email { background: var(--info); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; border: none; cursor: pointer; }
        .btn-whatsapp { background: var(--success); color: white; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; border: none; cursor: pointer; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        /* MODAIS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 1.5rem; width: 100%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; color: #64748b; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; box-sizing: border-box; font-family: inherit; }
        .modal-footer { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; flex: 2; font-weight: 600; }
        .btn-cancel { background: #f1f5f9; color: #64748b; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; flex: 1; font-weight: 600; }

        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div id="auth-container" style="
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="background:white;padding:40px;border-radius:16px;width:100%;max-width:400px;box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
    <h2 id="auth-title" style="text-align:center; color: #0f172a;">Squedy</h2>
    <p id="auth-subtitle" style="text-align:center; color: #64748b; margin-bottom: 20px;">Acesse sua conta para continuar</p>
    
    <input id="auth-email" type="email" placeholder="E-mail" style="width:100%;padding:10px;margin-bottom:10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
    <input id="auth-password" type="password" placeholder="Senha" style="width:100%;padding:10px;margin-bottom:15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
    
    <button id="auth-button" onclick="handleAuth()" style="width:100%;padding:12px;background:#2563eb;color:white;border:none;border-radius:8px; cursor: pointer; font-weight: bold;">
      Entrar
    </button>

    <p style="text-align:center; margin-top: 20px; font-size: 0.9rem; color: #64748b;">
      <span id="auth-switch-text">N√£o tem conta?</span> 
      <a href="javascript:void(0)" onclick="toggleAuthMode()" id="auth-switch-link" style="color: #2563eb; text-decoration: none; font-weight: bold;">Cadastre-se</a>
    </p>
  </div>
</div>
    <div class="sidebar">
			<h2><i class="fas fa-calendar-check"></i> Squedy</h2>
			
        <div class="nav-links">
            <a id="menu-lembretes" class="nav-item active" onclick="mudarAba('lembretes')"><i class="fas fa-home"></i> Dashboard</a>
            <a id="menu-clientes" class="nav-item" onclick="mudarAba('clientes')"><i class="fas fa-users"></i> Meus Clientes</a>
            <a id="menu-calendario" class="nav-item" onclick="mudarAba('calendario')"><i class="fas fa-calendar-alt"></i> Calend√°rio</a>
            <a id="menu-mensagens" class="nav-item" onclick="mudarAba('mensagens')"><i class="fas fa-comment-dots"></i> Mensagens</a>
            <a id="menu-configuracoes" class="nav-item" onclick="mudarAba('configuracoes')"><i class="fas fa-cog"></i> Configura√ß√µes</a>
        </div>
        <div style="padding: 20px; border-top: 1px solid #1e293b;">
<a href="javascript:void(0)" onclick="handleLogout()">Sair</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header-top">
            <div>
                <h1 style="margin: 0;">Painel de Controle üëã</h1>
                <p style="color: #64748b; margin-top: 5px;">Gerencie seus agendamentos.</p>
            </div>
            <button onclick="abrirModal()" class="btn-add"><i class="fas fa-plus"></i> Novo Agendamento</button>
        </div>

        <div id="secao-lembretes" class="aba-conteudo">
            <div class="stats-grid">
                <div class="stat-card"><h3>Clientes Ativos</h3><div id="count-clients" class="value">0</div></div>
                <div class="stat-card" style="border-color: var(--secondary);"><h3>Pendentes</h3><div id="count-pending" class="value">0</div></div>
                <div class="stat-card" style="border-color: var(--success);"><h3>Total Geral</h3><div id="count-total" class="value">0</div></div>
            </div>
			
			<div class="filter-container">
                <input type="text" id="filter-nome" onkeyup="filtrarDashboard()" placeholder="Filtrar por nome...">
				<input type="text" id="filter-motivo" onkeyup="filtrarDashboard()" placeholder="Filtrar por motivo...">
            </div>		
            <div class="data-table-container">
                <div class="table-header"><h2>Lembretes Priorit√°rios</h2></div>
                <table>
                    <thead><tr><th>CLIENTE</th><th>MOTIVO</th><th>DATA VENC.</th><th>STATUS</th><th>A√á√ÉO</th></tr></thead>
                    <tbody id="tabela-corpo"></tbody>
                </table>
            </div>
        </div>

        <div id="secao-clientes" class="aba-conteudo" style="display:none;">
            <div class="data-table-container">
                <div class="table-header"><h2>Minha Base de Clientes</h2></div>
                <table>
                    <thead><tr><th>NOME</th><th>WHATSAPP</th><th>CADASTRO</th><th>A√á√ïES</th></tr></thead>
                    <tbody id="tabela-clientes-corpo"></tbody>
                </table>
            </div>
        </div>

        <div id="secao-calendario" class="aba-conteudo" style="display:none;">
            <div class="data-table-container"><div id='calendar'></div></div>
        </div>

        <div id="secao-mensagens" class="aba-conteudo" style="display:none;">
            <div class="data-table-container">
                <div class="header-top">
                    <h2>Modelos de Mensagem</h2>
                    <button onclick="abrirModalTemplate()" class="btn-add"><i class="fas fa-plus"></i> Novo Modelo</button>
                </div>
                <div id="grid-templates" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>
            </div>
        </div>

        <div id="secao-configuracoes" class="aba-conteudo" style="display:none;">
            <div class="data-table-container" style="max-width: 600px;">
                 <h2>Backup dos Clientes</h2>
                  <!-- <div class="form-group"><label>Nome da Empresa</label><input type="text" id="config_business_name"></div>
                <div class="form-group"><label>Nome do Respons√°vel</label><input type="text" id="config_owner_name"></div>
                <div class="form-group"><label>Rodap√© Padr√£o</label><textarea id="config_footer" rows="2"></textarea></div>
                <button onclick="salvarConfiguracoes()" class="btn-add" style="width:100%; justify-content:center;">Salvar Ajustes</button>
                <hr style="margin:20px 0;"> -->
                <button onclick="exportarExcel()" class="btn-whatsapp" style="width:100%; background:var(--dark-blue); justify-content:center;">Exportar CSV</button>
            </div>
        </div>
    </div>

        <div id="modalAgendamento" class="modal-overlay">
        <div class="modal-content">
         <div class="form-group">
				<label>Cliente <i class="fas fa-info-circle info-tip" data-tip="Dica: Se o cliente j√° existir, o sistema preencher√° o WhatsApp automaticamente."></i></label>
				<input type="text" id="new_name" list="lista-clientes-sugeridos" oninput="autoPreencherTelefone(this.value)" placeholder="Nome do cliente">
				<datalist id="lista-clientes-sugeridos"></datalist>
			</div>

			<div class="form-group">
				<label>WhatsApp <i class="fas fa-info-circle info-tip" data-tip="Insira o n√∫mero com DDD sem o digito 9 na frente. Exemplo: 11999998888."></i></label>
				<input type="text" id="new_phone" placeholder="DDD + N√∫mero">
			</div>

			<div class="form-group">
				<label>Servi√ßo <i class="fas fa-info-circle info-tip" data-tip="Digite motivo personalizado."></i></label>
				<input type="text" id="new_title" list="lista-servicos" placeholder="Ex: Revis√£o, Troca de √ìleo">
				<datalist id="lista-servicos"></datalist>
			</div>
            <div class="form-group">
                <label>Data de Vencimento</label>
                <input type="date" id="new_date">
            </div>
            <div class="form-group">
                <label>Modelo de Mensagem</label>
                <select id="select_template" onchange="aplicarTemplate(this.value)">
                    <option value="">Selecione um modelo...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Mensagem Personalizada</label>
                <textarea id="new_msg" rows="3">Ol√° {name}, seu servi√ßo de {title} vence dia {date}. Podemos agendar?</textarea>
            </div>
            <div class="modal-footer">
                <button onclick="fecharModal()" class="btn-cancel">Cancelar</button>
                <button onclick="salvarAgendamento()" class="btn-save">Salvar</button>
            </div>
        </div>
    </div>
	<div id="modalHistorico" class="modal-overlay">
		<div class="modal-content" style="max-width: 600px;">
			<h3 id="hist_cliente_nome">Hist√≥rico do Cliente</h3>
			<div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
				<table style="font-size: 0.85rem;">
					<thead>
						<tr>
							<th>Data</th>
							<th>Servi√ßo</th>
							<th>Status</th>
						</tr>
					</thead>
					<tbody id="tabela-historico-corpo">
						</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button onclick="document.getElementById('modalHistorico').style.display='none'" class="btn-cancel">Fechar</button>
			</div>
		</div>
	</div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
		let lembretesCache = []; // Guarda os lembretes para busca r√°pida
		const SUPABASE_URL = 'https://zfyyiarsvjiisdvnhvtk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_EJIgtPIhhfnIyaALnIw0JQ_r6Kc6cbp'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let calendar;
        let clientesCadastrados = [];

        // FUN√á√ÉO PARA MUDAR ABAS
        function mudarAba(idAba) {
            document.querySelectorAll('.aba-conteudo').forEach(aba => aba.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById('secao-' + idAba).style.display = 'block';
            document.getElementById('menu-' + idAba).classList.add('active');

            if(idAba === 'clientes') carregarListaClientes();
            if(idAba === 'lembretes') carregarDados();
            if(idAba === 'calendario') inicializarCalendario();
            if(idAba === 'mensagens') carregarTemplates();
            if(idAba === 'configuracoes') carregarConfiguracoes();
        }
function inicializarCalendario() {
    const calendarEl = document.getElementById('calendar');
    
    // Se o calend√°rio j√° existe, apenas for√ßa o redimensionamento e para aqui
    if (calendar) { 
        calendar.updateSize();
        return; 
    }

    // Criar a inst√¢ncia do calend√°rio traduzida
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br', // Define o idioma para Portugu√™s
        buttonText: {
            today: 'Hoje',
            month: 'M√™s',
            week: 'Semana',
            day: 'Dia',
            list: 'Lista'
        },
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
        },
        // Busca os eventos do Supabase
        events: async function(info, successCallback, failureCallback) {
            try {
                const { data, error } = await _supabase
                    .from('reminders')
                    .select('title, event_date, status, clients(name)');

                if (error) throw error;

                const evts = data.map(i => ({
                    title: `${i.clients?.name || 'Cliente'}: ${i.title}`,
                    start: i.event_date,
                    // Cor: Verde se enviado, Azul se pendente
                    backgroundColor: i.status === 'sent' ? '#10b981' : '#2563eb',
                    borderColor: i.status === 'sent' ? '#10b981' : '#2563eb',
                    allDay: true
                }));

                successCallback(evts);
            } catch (err) {
                console.error("Erro no calend√°rio:", err);
                failureCallback(err);
            }
        }
    });

    calendar.render();
}
		 // FILTROS
			function filtrarDashboard() {
            const nome = document.getElementById('filter-nome').value.toLowerCase();
            const motivo = document.getElementById('filter-motivo').value.toLowerCase();
            const filtrados = lembretesCache.filter(i => i.clients.name.toLowerCase().includes(nome) && i.title.toLowerCase().includes(motivo));
            renderizarTabelaLembretes(filtrados);
        }

			function renderizarTabelaLembretes(lista) {
				const tbody = document.getElementById('tabela-corpo');
				tbody.innerHTML = lista.length ? '' : '<tr><td colspan="5">Nenhum pendente encontrado.</td></tr>';
				
				// Objeto para converter os termos do banco para o que o usu√°rio v√™
				const traducaoStatus = {
					'pending': 'Pendente',
					'sent': 'Enviado',
					'ignored': 'Ignorado'
				};

				lista.forEach(item => {
					const linkWa = `https://wa.me/${item.clients?.phone}?text=${encodeURIComponent(item.message_template)}`;
					const linkEmail = item.clients?.email ? `mailto:${item.clients.email}?subject=Lembrete&body=${encodeURIComponent(item.message_template)}` : '#';

					// Pega o status em portugu√™s usando o dicion√°rio acima
					const statusPT = traducaoStatus[item.status] || item.status;

					tbody.innerHTML += `<tr>
						<td><strong>${item.clients?.name || 'Sem Nome'}</strong></td>
						<td>${item.title}</td>
						<td>${new Date(item.event_date + 'T12:00:00').toLocaleDateString()}</td>
						<td><span class="badge-status status-hoje">${statusPT}</span></td>
						<td>
							<div class="action-buttons">
								<a href="${linkWa}" target="_blank" class="btn-whatsapp" onclick="marcarComoEnviado('${item.id}')"><i class="fab fa-whatsapp"></i> WhatsApp</a>
								<a href="${linkEmail}" class="btn-email" style="${item.clients?.email ? '' : 'display:none'}" onclick="marcarComoEnviado('${item.id}')"><i class="fas fa-envelope"></i> E-mail</a>
								<button class="btn-ignore" onclick="ignorarLembrete('${item.id}')"><i class="fas fa-eye-slash"></i> Ignorar</button>
							</div>
						</td>
					</tr>`;
				});
			}
			
						function filtrarDashboard() {
				const nomeBusca = document.getElementById('filter-nome').value.toLowerCase();
				const motivoBusca = document.getElementById('filter-motivo').value.toLowerCase();

				const filtrados = lembretesCache.filter(item => {
					const nomeOk = (item.clients?.name || '').toLowerCase().includes(nomeBusca);
					const motivoOk = (item.title || '').toLowerCase().includes(motivoBusca);
					return nomeOk && motivoOk;
				});

				renderizarTabelaLembretes(filtrados);
			}
        // --- GEST√ÉO DE CLIENTES ---
        async function carregarListaClientes() {
            const { data, error } = await _supabase.from('clients').select('*').order('name');
            const tbody = document.getElementById('tabela-clientes-corpo');
            tbody.innerHTML = '';
            if(data) {
                data.forEach(c => {
                    tbody.innerHTML += `<tr>
                        <td><strong>${c.name}</strong></td>
                        <td>${c.phone}</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td><button onclick="verHistorico('${c.id}', '${c.name}')" class="btn-add" style="padding:5px 10px;">Hist√≥rico</button></td>
                    </tr>`;
                });
            }
        }
	
					async function verHistorico(clientId, clientName) {
				// 1. Abre o modal e limpa a tabela
				document.getElementById('modalHistorico').style.display = 'flex';
				document.getElementById('hist_cliente_nome').innerText = `Hist√≥rico: ${clientName}`;
				const tbody = document.getElementById('tabela-historico-corpo');
				tbody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';

				// Dicion√°rio de tradu√ß√£o para os status
				const traducaoStatus = {
					'pending': 'Pendente',
					'sent': 'Enviado',
					'ignored': 'Ignorado'
				};

				// 2. Busca os agendamentos desse cliente no Supabase
				const { data, error } = await _supabase
					.from('reminders')
					.select('*')
					.eq('client_id', clientId)
					.order('event_date', { ascending: false });

				if (error) {
					tbody.innerHTML = '<tr><td colspan="3">Erro ao carregar dados.</td></tr>';
					return;
				}

				// 3. Preenche a tabela
				tbody.innerHTML = data.length ? '' : '<tr><td colspan="3">Nenhum registro encontrado.</td></tr>';
				
				data.forEach(item => {
					// Traduz o status ou mant√©m o original caso n√£o encontre no dicion√°rio
					const statusPT = traducaoStatus[item.status] || item.status;
					
					// Define a cor baseada no status para facilitar a leitura
					const statusCor = item.status === 'sent' ? 'var(--success)' : 
									  item.status === 'pending' ? 'var(--secondary)' : '#64748b';

					tbody.innerHTML += `
						<tr>
							<td>${new Date(item.event_date + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
							<td>${item.title}</td>
							<td><span style="color: ${statusCor}; font-weight: bold;">${statusPT}</span></td>
						</tr>`;
				});
			}
        // --- DASHBOARD / LEMBRETES ---
        async function carregarDados() {
    // Mant√©m seus contadores originais
    const { count: cT } = await _supabase.from('reminders').select('*', { count: 'exact', head: true });
    const { count: cP } = await _supabase.from('reminders').select('*', { count: 'exact', head: true }).eq('status', 'pending');
    const { count: cC } = await _supabase.from('clients').select('*', { count: 'exact', head: true });
    
    document.getElementById('count-total').innerText = cT || 0;
    document.getElementById('count-pending').innerText = cP || 0;
    document.getElementById('count-clients').innerText = cC || 0;

    // Busca os dados incluindo e-mail dos clientes
    const { data } = await _supabase.from('reminders').select('*, clients(name, phone, email)').eq('status', 'pending').order('event_date');
    
    lembretesCache = data || []; // Alimenta o cache
    renderizarTabelaLembretes(lembretesCache); // Chama a fun√ß√£o visual
}
				// --- CONFIGURA√á√ïES ---
				async function carregarConfiguracoes() {
					const { data } = await _supabase.from('settings').select('*').maybeSingle();
					if(data) {
						document.getElementById('config_business_name').value = data.business_name || '';
						document.getElementById('config_owner_name').value = data.owner_name || '';
						document.getElementById('config_footer').value = data.footer_message || '';
						document.getElementById('sidebar-business-name').innerText = data.business_name || 'SQUEDY';
					}
				}

				async function salvarConfiguracoes() {
					const payload = {
						id: 1,
						business_name: document.getElementById('config_business_name').value,
						owner_name: document.getElementById('config_owner_name').value,
						footer_message: document.getElementById('config_footer').value
					};
					await _supabase.from('settings').upsert(payload);
					alert("Ajustes salvos!");
					carregarConfiguracoes();
				}
		async function exportarExcel() {
			// Busca todos os clientes do banco
			const { data, error } = await _supabase.from('clients').select('name, phone, created_at').order('name');

			if (error) {
				alert("Erro ao buscar dados: " + error.message);
				return;
			}

			if (!data || data.length === 0) {
				alert("N√£o h√° clientes para exportar.");
				return;
			}

			// Cria o cabe√ßalho do CSV
			let csvContent = "Nome;WhatsApp;Data de Cadastro\n";

			// Adiciona as linhas
			data.forEach(user => {
				const dataFormatada = new Date(user.created_at).toLocaleDateString();
				csvContent += `${user.name};${user.phone};${dataFormatada}\n`;
			});

			// Cria o arquivo para download (formato CSV compat√≠vel com Excel)
			const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement("a");
			
			link.setAttribute("href", url);
			link.setAttribute("download", "clientes_squedy.csv");
			link.style.visibility = 'hidden';
			
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}
        // --- SALVAR AGENDAMENTO ---
// --- SALVAR AGENDAMENTO ATUALIZADO ---
async function salvarAgendamento() {
    // 1. Pegar o usu√°rio logado no momento
    const { data: { user } } = await _supabase.auth.getUser();
    
    if (!user) {
        alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
        return;
    }

    const nome = document.getElementById('new_name').value;
    const fone = document.getElementById('new_phone').value.replace(/\D/g, '');
    const dataRef = document.getElementById('new_date').value;
    
    // 2. Salvar/Atualizar Cliente (passando o user_id e tratando o conflito duplo)
    const { data: cliente, error: errorCliente } = await _supabase
        .from('clients')
        .upsert({ 
            name: nome, 
            phone: fone, 
            user_id: user.id // Vincula o cliente ao seu usu√°rio
        }, { 
            onConflict: 'phone,user_id' // A chave √∫nica agora s√£o os dois campos
        })
        .select()
        .single();

    if (errorCliente) {
        console.error("Erro ao salvar cliente:", errorCliente);
        alert("Erro ao identificar cliente. Verifique os dados.");
        return;
    }
    
    // 3. Inserir o Lembrete vinculado ao cliente e ao usu√°rio
    const { error: errorLembrete } = await _supabase
        .from('reminders')
        .insert({
            client_id: cliente.id,
            user_id: user.id, // Garante que o lembrete √© seu
            title: document.getElementById('new_title').value,
            event_date: dataRef,
            message_template: document.getElementById('new_msg').value,
            status: 'pending'
        });

    if (errorLembrete) {
        console.error("Erro ao salvar lembrete:", errorLembrete);
        alert("Erro ao agendar lembrete.");
    } else {
        fecharModal();
        carregarDados();
        // Opcional: recarregar lista de clientes para o auto-complete atualizar
        if (typeof carregarListaClientes === "function") carregarListaClientes();
    }
}

// --- GEST√ÉO DE MODELOS DE MENSAGENS (GRID) ---
			async function carregarTemplates() {
				const grid = document.getElementById('grid-templates');
				grid.innerHTML = '<p style="padding: 20px;">Carregando modelos...</p>';
				
				const { data, error } = await _supabase.from('message_templates').select('*').order('title');

				if (error) {
					grid.innerHTML = '<p style="color: red;">Erro ao carregar modelos.</p>';
					return;
				}

				grid.innerHTML = '';
				if (data && data.length > 0) {
					data.forEach(t => {
						grid.innerHTML += `
							<div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
								<h3 style="margin: 0 0 10px 0; font-size: 1.1rem; color: var(--dark-blue);">${t.title}</h3>
								<p style="font-size: 0.85rem; color: #64748b; line-height: 1.5; margin-bottom: 15px;">
									${t.content.substring(0, 100)}${t.content.length > 100 ? '...' :Âüã}
								</p>
								<button onclick="excluirTemplate('${t.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.8rem; font-weight: 600; padding: 0;">
									<i class="fas fa-trash-alt"></i> Excluir Modelo
								</button>
							</div>`;
					});
				} else {
					grid.innerHTML = '<p style="color: #64748b; padding: 20px;">Nenhum modelo cadastrado.</p>';
				}
			}

				// --- FUN√á√ïES PARA CRIAR E EXCLUIR ---
				function abrirModalTemplate() {
					const titulo = prompt("T√≠tulo do Modelo (ex: Lembrete de Revis√£o):");
					if (!titulo) return;
					const conteudo = prompt("Conte√∫do da Mensagem (Dica: Use [NOME] para personalizar depois):");
					if (!conteudo) return;
					
					salvarNovoTemplate(titulo, conteudo);
				}

				async function salvarNovoTemplate(title, content) {
					const { error } = await _supabase.from('message_templates').insert([{ title, content }]);
					if (!error) {
						alert("Modelo salvo com sucesso!");
						carregarTemplates();
					} else {
						alert("Erro ao salvar: " + error.message);
					}
				}

				async function excluirTemplate(id) {
					if (confirm("Tem certeza que deseja excluir este modelo definitivamente?")) {
						const { error } = await _supabase.from('message_templates').delete().eq('id', id);
						if (!error) {
							carregarTemplates();
						} else {
							alert("Erro ao excluir: " + error.message);
						}
					}
}
        // --- OUTRAS FUN√á√ïES AUXILIARES (MODAL, TEMPLATES, AUTOFILL) ---

        async function abrirModal() { 
            try {
                document.getElementById('modalAgendamento').style.display = 'flex'; 
                await carregarSelectTemplates(); 
                await carregarSugestoesClientes(); // Carrega lista para Auto Fill
                await carregarServicos();          // Carrega lista de Servi√ßos
            } catch (e) {
                console.error("Erro ao abrir modal:", e);
            }
        }

        function fecharModal() { 
            document.getElementById('modalAgendamento').style.display = 'none'; 
        }
        
        async function carregarSelectTemplates() {
            const { data } = await _supabase.from('message_templates').select('*');
            const sel = document.getElementById('select_template');
            if (sel) {
                sel.innerHTML = '<option value="">Selecione...</option>';
                data?.forEach(t => sel.innerHTML += `<option value="${t.content}">${t.title}</option>`);
            }
        }

        // 1. Fun√ß√£o para buscar servi√ßos e popular o datalist
        async function carregarServicos() {
            const { data } = await _supabase.from('services').select('name').order('name');
            const datalist = document.getElementById('lista-servicos');
            if (datalist) {
                datalist.innerHTML = '';
                data?.forEach(s => datalist.innerHTML += `<option value="${s.name}">`);
            }
        }

        // 2. Fun√ß√£o para buscar clientes para o Auto Fill
        async function carregarSugestoesClientes() {
            const { data } = await _supabase.from('clients').select('name, phone');
            const datalist = document.getElementById('lista-clientes-sugeridos');
            clientesCadastrados = data || []; 
            if (datalist) {
                datalist.innerHTML = '';
                clientesCadastrados.forEach(c => datalist.innerHTML += `<option value="${c.name}">`);
            }
        }

        // 3. L√≥gica do Auto Fill
        function autoPreencherTelefone(nomeDigitado) {
            if (!nomeDigitado) return;
            const cliente = clientesCadastrados.find(c => c.name === nomeDigitado);
            if (cliente) {
                const inputFone = document.getElementById('new_phone');
                if (inputFone) inputFone.value = cliente.phone;
            }
        }

        function aplicarTemplate(val) { 
            if(val) document.getElementById('new_msg').value = val; 
        }

// Alterado para pedir confirma√ß√£o antes de marcar como enviado
async function marcarComoEnviado(id) {
    const confirmacao = confirm("Deseja enviar este lembrete?");
    if (!confirmacao) return;

    const { error } = await _supabase.from('reminders').update({ status: 'sent' }).eq('id', id);
    if (!error) {
        carregarDados();
    } else {
        alert("Erro ao atualizar: " + error.message);
    }
}

// Alterado para pedir confirma√ß√£o antes de ignorar/remover da lista
async function ignorarLembrete(id) {
    const confirmacao = confirm("Tem certeza que deseja IGNORAR este lembrete? Ele deixar√° de aparecer no seu dashboard.");
    if (!confirmacao) return;

    const { error } = await _supabase.from('reminders').update({ status: 'ignored' }).eq('id', id);
    if (!error) {
        carregarDados();
    }
}

        // In√≠cio
        window.onload = carregarDados;
		/* === AUTH GUARD SUPABASE === */
async function checkAuthGuard() {
  const { data: { user } } = await _supabase.auth.getUser();
  if (user) {
    document.getElementById('auth-container').style.display = 'none';
  } else {
    document.getElementById('auth-container').style.display = 'flex';
  }
}

/* === SISTEMA DE AUTENTICA√á√ÉO (LOGIN E CADASTRO) === */
let isSignUpMode = false; // Controla se estamos na tela de login ou cadastro

// Fun√ß√£o que alterna os textos da tela
function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    const btn = document.getElementById('auth-button'); // Certifique-se que o id do seu bot√£o √© este
    const link = document.getElementById('auth-switch-link');
    const title = document.querySelector('#auth-container h2');

    if (isSignUpMode) {
        title.innerText = "Criar Conta";
        btn.innerText = "Cadastrar";
        link.innerText = "J√° tem conta? Entrar";
    } else {
        title.innerText = "Squedy";
        btn.innerText = "Entrar";
        link.innerText = "N√£o tem conta? Cadastre-se";
    }
}

async function handleAuth() {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;

    if (!email || !password) {
        alert("Preencha e-mail e senha.");
        return;
    }

    if (isSignUpMode) {
        // Tenta CADASTRAR novo usu√°rio
        const { error } = await _supabase.auth.signUp({ email, password });
        if (error) {
            alert("Erro no cadastro: " + error.message);
        } else {
            alert("Cadastro realizado! Verifique seu e-mail para confirmar.");
            toggleAuthMode(); // Volta para tela de login ap√≥s cadastrar
        }
    } else {
        // Tenta fazer LOGIN (sua l√≥gica original)
        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) {
            alert("Erro no login: " + error.message);
        } else {
            checkAuthGuard(); // Esconde o painel de login
            carregarDados();  // Carrega os dados do banco
        }
    }
}
/* === LOGOUT (substitui o link antigo) === */
async function handleLogout() {
  if (!confirm("Deseja sair?")) return;
  await _supabase.auth.signOut();
  location.reload();
}

/* Executa ap√≥s tudo carregar */
window.addEventListener('load', checkAuthGuard);
    </script>
</body>
</html>