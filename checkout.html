<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Seguro - Squedy App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #f59e0b;
            --success: #22c55e;
            --gray: #64748b;
            --bg: #f1f5f9;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .checkout-container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        h2 { margin-top: 0; font-size: 1.5rem; color: var(--primary); }
        .plan-option {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-option:hover { border-color: var(--primary); background: #f8fafc; }
        
        .btn-checkout {
            width: 100%;
            background: var(--success);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-checkout:hover { background: #16a34a; transform: translateY(-2px); }

        .price-summary { background: #f8fafc; padding: 20px; border-radius: 12px; height: fit-content; }
        .item-price { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--gray); }
        .total { font-size: 1.3rem; font-weight: bold; color: #1e293b; border-top: 1px solid #e2e8f0; padding-top: 10px; }
        
        .badge-anual { background: var(--secondary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="checkout-container">
        <div class="card">
            <h2><i class="fas fa-credit-card" style="margin-right: 10px;"></i> Selecione seu Plano</h2>
            <p style="color: var(--gray);">Voc√™ ser√° redirecionado para o ambiente seguro do Pagar.me para concluir o pagamento.</p>

            <div class="plan-option" onclick="selecionarPlano('mensal')">
                <div>
                    <strong>Plano Mensal</strong><br>
                    <small>Acesso total ao sistema</small>
                </div>
                <div>
                    <span style="font-weight: bold; color: var(--primary);">R$ 97,00</span>
                </div>
            </div>

            <div class="plan-option" onclick="selecionarPlano('anual')">
                <div>
                    <strong>Plano Anual</strong> <span class="badge-anual">ECONOMIZE 20%</span><br>
                    <small>Ideal para empresas estabelecidas</small>
                </div>
                <div>
                    <span style="font-weight: bold; color: var(--primary);">R$ 970,00</span>
                </div>
            </div>

            <button onclick="alert('Por favor, selecione um dos planos acima para prosseguir.')" class="btn-checkout">
                PAGAR COM SEGURAN√áA
            </button>
        </div>

        <div class="price-summary">
            <h3>Resumo do Pedido</h3>
            <div class="item-price">
                <span>Assinatura Squedy</span>
                <span>R$ 97,00</span>
            </div>
            <div class="item-price">
                <span>Taxa de Ativa√ß√£o</span>
                <span style="color:var(--success)">GR√ÅTIS</span>
            </div>
            <div class="total">
                <span>TOTAL HOJE</span>
                <span>R$ 97,00</span>
            </div>

            <div style="margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                <small style="color: var(--gray);">
                    <i class="fas fa-lock"></i> Pagamento processado por <strong>Pagar.me (Stone Co.)</strong>. 
                    Seu cart√£o e seus dados est√£o 100% seguros.
                </small>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO SUPABASE
        const SUPABASE_URL = 'https://zfyyiarsvjiisdvnhvtk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_EJIgtPIhhfnIyaALnIw0JQ_r6Kc6cbp'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function selecionarPlano(idDoPlano) {
            const { data: { session } } = await _supabase.auth.getSession();

            if (!session) {
                alert("Sess√£o expirada. Por favor, fa√ßa login novamente.");
                window.location.href = 'painel.html';
                return;
            }

            try {
                // URL da sua Edge Function no Supabase (precisa ser criada no painel do Supabase)
                const functionUrl = `${SUPABASE_URL}/functions/v1/criar-checkout`;

                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ plan_type: idDoPlano })
                });

                const data = await response.json();

                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else {
                    console.error("Resposta da fun√ß√£o:", data);
                    alert("Erro ao gerar link de pagamento. Tente novamente.");
                }
            } catch (error) {
                console.error("Erro no checkout:", error);
                alert("Falha na conex√£o. Tente novamente em instantes.");
            }
        }

        // L√ìGICA DE MENSAGENS DE STATUS (TRIAL EXPIRADO, ETC)
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');

        if (status) {
            const mensagemBox = document.createElement('div');
            mensagemBox.style = "grid-column: 1 / -1; background:#fff3cd; color:#856404; padding:15px; border-radius:8px; margin-bottom:10px; text-align:center; border:1px solid #ffeeba; font-weight:bold;";
            
            if (status === 'trial_vencido') {
                mensagemBox.innerText = "üëã Seu per√≠odo de 3 dias de teste terminou. Escolha um plano abaixo para n√£o perder seus dados!";
            } else if (status === 'expirado') {
                mensagemBox.innerText = "Sua assinatura mensal expirou. Renove agora para reativar seu acesso ao Squedy.";
            } else if (status === 'erro') {
                mensagemBox.innerText = "Houve um erro t√©cnico. Por favor, tente selecionar o plano novamente.";
            }
            
            const container = document.querySelector('.checkout-container');
            container.prepend(mensagemBox);
        }
		import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Responde ao pre-flight do navegador (CORS)
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const PAGARME_API_KEY = Deno.env.get('PAGARME_API_KEY')
    
    // Inicializa Supabase para validar o usu√°rio
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    )

    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) throw new Error('N√£o autorizado')

    // Pega o tipo do plano vindo do seu checkout.html
    const { plan_type } = await req.json()

    // Configura√ß√£o de Pre√ßos (Backend blindado)
    const amount = plan_type === 'anual' ? 97000 : 9700 // Valores em centavos
    const planName = plan_type === 'anual' ? 'Squedy Anual' : 'Squedy Mensal'

    // Chama o Pagar.me para criar o link de pagamento
    const response = await fetch('https://api.pagar.me/core/v5/checkouts', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${btoa(PAGARME_API_KEY + ':')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        customer_editable: false,
        payment_methods: ['credit_card', 'pix'],
        expires_in: 60, // Link vale por 60 minutos
        items: [{
          amount: amount,
          description: planName,
          quantity: 1,
          code: plan_type
        }],
        // Onde o cliente cai ap√≥s pagar
        success_url: "https://seu-dominio.com/painel.html?status=sucesso"
      })
    })

    const data = await response.json()

    return new Response(
      JSON.stringify({ checkout_url: data.checkout_url }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 200 }
    )

  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 400 }
    )
  }
})
    </script>
</body>
</html>